## ä»€ä¹ˆæ˜¯å¿«é€Ÿå¤±è´¥(fail-fast)ï¼Ÿ
åœ¨ç”¨è¿­ä»£å™¨éå†é›†åˆæ—¶,å½“é›†åˆçš„ç»“æ„è¢«ä¿®æ”¹,ä¼šæŠ›å‡º`ConcurrentModificationException`å¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚

java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„, å¸¸è§çš„çš„ä½¿ç”¨fail-fastæ–¹å¼éå†çš„å®¹å™¨æœ‰`HashMap`å’Œ`ArrayList`ç­‰ã€‚

### fail-fast(å¿«é€Ÿå¤±è´¥)
- å¿«é€Ÿå¤±è´¥å‘ç”Ÿçš„æƒ…å†µï¼š
1. å•çº¿ç¨‹ç¯å¢ƒä¸‹
é›†åˆåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹é›†åˆè¿›è¡Œå¢åˆ æ“ä½œï¼Œæ²¡æœ‰è°ƒç”¨è¿­ä»£å™¨çš„æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨é›†åˆè‡ªèº«çš„æ–¹æ³•ï¼Œå°±ä¼šäº§ç”Ÿå¿«é€Ÿå¤±è´¥
```java
ArrayList<Integer> list = new ArrayList<>();
list.add(50);
list.add(40);
list.add(30);
Iterator<Integer> iterator = list.iterator();
while (iterator.hasNext()){
    System.out.println(iterator.next());
    list.add(60);// ä½¿ç”¨é›†åˆè‡ªèº«çš„addæ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œä¼šäº§ç”Ÿå¼‚å¸¸
    System.out.println("å½“å‰é›†åˆé•¿åº¦ä¸ºï¼š"+list.size());
}
```
è¿è¡Œç»“æœï¼š

![Alt text](img/Snipaste_2023-08-29_16-41-08.png)



è€ƒè™‘ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š
```java
ArrayList<Integer> list = new ArrayList<>();
list.add(50);
list.add(40);
list.add(30);
ListIterator<Integer> iterator = list.listIterator();
while (iterator.hasNext()){
    System.out.println(iterator.next());
    iterator.add(60); //ä½¿ç”¨è¿­ä»£å™¨çš„æ·»åŠ æ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸
    System.out.println("å½“å‰é›†åˆé•¿åº¦ä¸ºï¼š"+list.size());
}
```
è¿è¡Œç»“æœï¼š

![Alt text](img/Snipaste_2023-08-29_16-43-06.png)



ä¸Šè¿°ä»£ç åŒæ—¶æ¼”ç¤ºäº†é›†åˆçš„ä¸¤ä¸ªè¿­ä»£å™¨çš„ç”¨æ³•ï¼Œiteratorå’Œlistiteratorçš„è”ç³»ä¸åŒºåˆ«å¦‚ä¸‹ï¼š
#### ç›¸åŒç‚¹ï¼š
äºŒè€…ä½œç”¨éƒ½æ˜¯éå†é›†åˆã€‚å½“ä¸éœ€è¦åœ¨éå†æ—¶å¯¹é›†åˆå†…å®¹è¿›è¡Œå¹²æ¶‰æ—¶ï¼ŒäºŒè€…æ˜¯ç­‰æ•ˆçš„ã€‚
#### ä¸åŒç‚¹ï¼š
1. é€‚ç”¨èŒƒå›´ä¸åŒã€‚ iteratoré€‚ç”¨äºæ‰€æœ‰çš„é›†åˆï¼Œè€Œlistiteratoråªé€‚ç”¨äºlisté›†åˆ
2. iteratoræœ‰removeæ–¹æ³•ã€‚listiteratorç‰¹æœ‰add,setæ–¹æ³•ï¼Œç”¨äºæ·»åŠ ï¼Œä¿®æ”¹é›†åˆå…ƒç´ ã€‚
3. listiteratorå’Œiteratoréƒ½æœ‰hasNext()å’Œnext()æ–¹æ³•ï¼Œå¯ä»¥å®ç°å‘åéå†ã€‚ä½†æ˜¯listiteratorç‰¹æœ‰hasPrevious()å’Œprevious()æ–¹æ³•ï¼Œå¯ä»¥å®ç°å‘å‰éå†ã€‚
4. listiteratorå¯ä»¥å®šä½å½“å‰ç´¢å¼•ä½ç½®ã€‚é€šè¿‡nextIndex()æ–¹æ³•æˆ–è€…previousIndex()æ–¹æ³•å¯ä»¥ç¡®å®šåä¸€ä¸ªæˆ–å‰ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•ã€‚

#### ä¸ºä½•åœ¨è¿­ä»£å™¨éå†æ—¶ä¿®æ”¹é›†åˆå†…å®¹ä¼šå¯¼è‡´å¼‚å¸¸ï¼Ÿ
1. åœ¨è¿­ä»£å™¨éå†é›†åˆçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªmodCountå˜é‡æ¥è®°å½•é›†åˆä¸­çš„å†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœé›†åˆå†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šä¿®æ”¹modCountçš„å€¼ã€‚

![Alt text](img/Snipaste_2023-08-29_16-51-48.png)
ğŸ‘†modCountåœ¨AbstractListä¸­è¢«å®šä¹‰ä¸ºå—ä¿æŠ¤çš„transientæ•´å‹å€¼ã€‚è¿™æ„å‘³ç€è¯¥å€¼ä¸å¯è¢«åºåˆ—åŒ–ã€‚
2. è¿­ä»£å™¨åœ¨è¿›è¡Œnext()/hasNext()è¿›è¡Œéå†ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æŸ¥modCountå€¼æ˜¯å¦ä¸expectedModCountç›¸ç­‰ã€‚å¦‚æœä¸ç›¸ç­‰å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

![Alt text](img/Snipaste_2023-08-29_16-57-07.png)
ğŸ‘†ArrayListä¸­forEachæ–¹æ³•-å½“`modCount!=expectedModCount`æ—¶æŠ›å‡ºå¼‚å¸¸

ConcurrentModificationExceptionå¹¶å‘ä¿®æ”¹å¼‚å¸¸çš„å®˜æ–¹è§£é‡Šï¼š

![Alt text](img/Snipaste_2023-08-29_16-59-39.png)

## å®‰å…¨å¤±è´¥(fail-safe)
é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆï¼Œåœ¨éå†é›†åˆæ—¶ä¼šå°†åŸé›†åˆå¤åˆ¶ä¸€ä»½ã€‚å¹¶åœ¨å¤åˆ¶åçš„é›†åˆä¸­è¿›è¡Œéå†æ“ä½œã€‚å› æ­¤ä¿®æ”¹é›†åˆå†…å®¹å¹¶ä¸ä¼šè§¦å‘å¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚

java.util.concurrentåŒ…ä¸‹é¢çš„æ‰€æœ‰çš„ç±»éƒ½æ˜¯å®‰å…¨å¤±è´¥çš„,å¦‚ConcurrentHashMap, CopyOnWriteArrayListç­‰

å®‰å…¨å¤±è´¥ç¤ºä¾‹ä»£ç ï¼š
```java
ConcurrentHashMap<Integer, String> map = new ConcurrentHashMap<>();
map.put(1, "a");
map.put(2, "b");
map.put(3, "c");
Set<Map.Entry<Integer, String>> entries = map.entrySet();
Iterator<Map.Entry<Integer, String>> iterator = entries.iterator();
while (iterator.hasNext()){
    System.out.println(iterator.next());
    map.put(4, "d");
}
```
è¿è¡Œç»“æœï¼š

![Alt text](img/Snipaste_2023-08-29_17-08-54.png)

#### åœ¨éå†å¹¶å‘å“ˆå¸Œæ˜ å°„æ—¶ä¸å‘ç”Ÿå¹¶å‘ä¿®æ”¹å¼‚å¸¸ï¼Œä¸ºä»€ä¹ˆï¼Ÿ
å› ä¸ºå¹¶å‘å“ˆå¸Œæ˜ å°„é‡‡ç”¨å®‰å…¨å¤±è´¥çš„æœºåˆ¶ï¼Œå…¶è¿­ä»£å™¨éå†çš„æ˜¯åŸæ˜ å°„çš„å¿«ç…§(å¤‡ä»½),å› æ­¤è¿­ä»£å™¨å¹¶ä¸ä¼šæ ¡éªŒmodCountæ˜¯å¦è¢«ä¿®æ”¹ã€‚å› æ­¤ä¸ä¼šäº§ç”Ÿå¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚

## æ€»ç»“
fail-safeï¼ˆå®‰å…¨å¤±è´¥ï¼‰å…è®¸åœ¨éå†çš„è¿‡ç¨‹ä¸­å¯¹å®¹å™¨ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œè€Œfail-fastï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰åˆ™ä¸å…è®¸ã€‚